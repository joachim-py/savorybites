{% extends 'layout.html' %}
{% block title %} Checkout {% endblock title %}
{% block cart %} {% endblock cart %}

{% block content %}
{% if cart_items %}
<div class="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-yellow-50">
    <div class="max-w-7xl mx-auto px-4 pb-12 pt-24">
        <!-- Page Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-2">
                Checkout
                <span class="inline-block ml-2 text-amber-500">üõçÔ∏è</span>
            </h1>
            <div class="w-24 h-1 bg-gradient-to-r from-amber-400 to-orange-400 mx-auto rounded-full"></div>
            <p class="text-gray-600 mt-4 text-lg">Almost there! Complete your order below</p>
        </div>

        <!-- Progress Steps -->
        <div class="max-w-3xl mx-auto mb-12">
            <div class="flex items-center justify-center space-x-4 md:space-x-8">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gradient-to-r from-emerald-400 to-teal-400 rounded-full flex items-center justify-center shadow-lg">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <span class="ml-2 text-sm font-medium text-gray-700">Cart</span>
                </div>
                <div class="flex-1 h-1 bg-gradient-to-r from-emerald-400 to-amber-400 rounded-full mx-2"></div>
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gradient-to-r from-amber-400 to-orange-400 rounded-full flex items-center justify-center shadow-lg animate-pulse">
                        <span class="text-white font-bold text-sm">2</span>
                    </div>
                    <span class="ml-2 text-sm font-medium text-amber-600">Checkout</span>
                </div>
                <div class="flex-1 h-1 bg-gray-200 rounded-full mx-2"></div>
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                        <span class="text-gray-400 font-bold text-sm">3</span>
                    </div>
                    <span class="ml-2 text-sm font-medium text-gray-400">Payment</span>
                </div>
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="max-w-4xl mx-auto mb-6">
            {% for message in messages %}
            <div class="mb-4 p-4 rounded-xl border-l-4 shadow-sm animate-fade-in
                {% if message.tags == 'error' %}bg-red-50 border-red-400 text-red-700
                {% elif message.tags == 'success' %}bg-green-50 border-green-400 text-green-700
                {% else %}bg-blue-50 border-blue-400 text-blue-700{% endif %}">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        {% if message.tags == 'error' %}
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        {% elif message.tags == 'success' %}
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        {% else %}
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        {% endif %}
                    </svg>
                    {{ message }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="POST" action="{% url 'checkout' %}" id="checkoutForm">
            {% csrf_token %}
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 max-w-4xl mx-auto">
                <!-- Shipping Information - Left Side -->
                <div class="lg:col-span-3">
                    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-6 md:p-8 mb-8">
                        <!-- Contact Information -->
                        <div class="mb-8">
                            <div class="flex items-center space-x-3 mb-6">
                                <div class="w-10 h-10 bg-gradient-to-r from-blue-400 to-purple-400 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <h2 class="text-2xl font-bold text-gray-800">Contact Information</h2>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="group">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name *</label>
                                    <div class="relative">
                                        <input required type="text" name="full_name" value="{{ user.get_full_name }}" 
                                               class="w-full px-4 py-3 pl-12 rounded-xl border-2 border-gray-200 focus:border-amber-400 focus:ring-4 focus:ring-amber-100 transition-all duration-300 bg-white shadow-sm group-hover:shadow-md">
                                        <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                </div>
                                
                                <div class="group">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Phone Number *</label>
                                    <div class="relative">
                                        <input required type="tel" name="phone" value="{{user.profile.phone_number}}" 
                                               class="w-full px-4 py-3 pl-12 rounded-xl border-2 border-gray-200 focus:border-amber-400 focus:ring-4 focus:ring-amber-100 transition-all duration-300 bg-white shadow-sm group-hover:shadow-md">
                                        <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 group">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Email Address *</label>
                                <div class="relative">
                                    <input required type="email" name="email" value="{{ user.email }}" 
                                           class="w-full px-4 py-3 pl-12 rounded-xl border-2 border-gray-200 focus:border-amber-400 focus:ring-4 focus:ring-amber-100 transition-all duration-300 bg-white shadow-sm group-hover:shadow-md">
                                    <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                
                        <!-- Delivery Options -->
                        <div class="mb-6">
                            <div class="flex items-center space-x-2 mb-4">
                                <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-emerald-400 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                                        <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1V8a1 1 0 00-1-1h-3z"/>
                                    </svg>
                                </div>
                                <h2 class="text-xl font-bold text-gray-800">Delivery Options</h2>
                            </div>
                
                            <div class="grid grid-cols-1 gap-3">
                                <!-- Dine In -->
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="delivery_option" value="dine_in" id="dine_in" checked 
                                           class="sr-only peer">
                                    <div class="p-3 rounded-lg border-2 border-gray-200 peer-checked:border-amber-400 peer-checked:bg-amber-50 transition-all duration-300 hover:shadow group">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-gradient-to-r from-purple-400 to-pink-400 rounded-full flex items-center justify-center group-hover:scale-105 transition-transform">
                                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                                                </svg>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-bold text-gray-800">Dine In</h3>
                                                <p class="text-sm text-gray-600">Enjoy your meal at our restaurant</p>
                                            </div>
                                            <div class="w-5 h-5 rounded-full border-2 border-gray-300 peer-checked:border-amber-400 peer-checked:bg-amber-400 flex items-center justify-center">
                                                <div class="w-1.5 h-1.5 rounded-full bg-white peer-checked:opacity-100 opacity-0"></div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                
                                <!-- Takeaway -->
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="delivery_option" value="takeaway" id="takeaway" 
                                           class="sr-only peer">
                                    <div class="p-3 rounded-lg border-2 border-gray-200 peer-checked:border-amber-400 peer-checked:bg-amber-50 transition-all duration-300 hover:shadow group">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-gradient-to-r from-orange-400 to-red-400 rounded-full flex items-center justify-center group-hover:scale-105 transition-transform">
                                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M3 4a1 1 0 011-1h12a1 1 0 010 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h12a1 1 0 010 2H4a1 1 0 01-1-1z"/>
                                                </svg>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-bold text-gray-800">Takeaway</h3>
                                                <p class="text-sm text-gray-600">Pick up your order from our location</p>
                                            </div>
                                            <div class="w-5 h-5 rounded-full border-2 border-gray-300 peer-checked:border-amber-400 peer-checked:bg-amber-400 flex items-center justify-center">
                                                <div class="w-1.5 h-1.5 rounded-full bg-white peer-checked:opacity-100 opacity-0"></div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                
                                <!-- Delivery -->
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="delivery_option" value="delivery" id="delivery" 
                                           class="sr-only peer">
                                    <div class="p-3 rounded-lg border-2 border-gray-200 peer-checked:border-amber-400 peer-checked:bg-amber-50 transition-all duration-300 hover:shadow group">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-gradient-to-r from-green-400 to-blue-400 rounded-full flex items-center justify-center group-hover:scale-105 transition-transform">
                                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                                                    <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1V8a1 1 0 00-1-1h-3z"/>
                                                </svg>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-bold text-gray-800">Delivery</h3>
                                                <p class="text-sm text-gray-600">We'll deliver to your doorstep</p>
                                            </div>
                                            <div class="w-5 h-5 rounded-full border-2 border-gray-300 peer-checked:border-amber-400 peer-checked:bg-amber-400 flex items-center justify-center">
                                                <div class="w-1.5 h-1.5 rounded-full bg-white peer-checked:opacity-100 opacity-0"></div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                
                            <!-- Delivery Address Field -->
                            <div class="delivery_address hidden mt-4 animate-fade-in">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Delivery Address *</label>
                                <div class="relative group">
                                    <textarea name="address" rows="2" 
                                              class="w-full px-3 py-2 pl-10 rounded-lg border-2 border-gray-200 focus:border-amber-400 focus:ring-2 focus:ring-amber-100 transition-all duration-300 bg-white shadow-sm group-hover:shadow resize-none" 
                                              placeholder="Enter your complete delivery address...">{{user.profile.address}}</textarea>
                                    <svg class="absolute left-3 top-3 w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <small class="text-red-600 mt-1 hidden addressError text-xs">Delivery Address is required.</small>
                            </div>
                        </div>
                
                        <!-- Special Instructions -->
                        <div>
                            <div class="flex items-center space-x-2 mb-4">
                                <div class="w-8 h-8 bg-gradient-to-r from-indigo-400 to-purple-400 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">Special Instructions</h3>
                            </div>
                            
                            <div class="relative group">
                                <textarea name="notes" rows="3" 
                                          class="w-full px-3 py-2 pl-10 rounded-lg border-2 border-gray-200 focus:border-amber-400 focus:ring-2 focus:ring-amber-100 transition-all duration-300 bg-white shadow-sm group-hover:shadow resize-none" 
                                          placeholder="Any special instructions for your order (dietary requirements, cooking preferences, etc.)..."></textarea>
                                <svg class="absolute left-3 top-3 w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary - Right Side -->
                <div class="lg:col-span-2">
                    <div class="sticky top-24">
                        <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-6 md:p-8">
                            <!-- Summary Header -->
                            <div class="flex items-center space-x-3 mb-6">
                                <div class="w-8 h-8 bg-gradient-to-r from-amber-400 to-orange-400 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M3 4a1 1 0 011-1h12a1 1 0 010 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h12a1 1 0 010 2H4a1 1 0 01-1-1z"/>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">Order Summary</h3>
                            </div>

                            <!-- Order Items -->
                            <div class="space-y-4 mb-8 max-h-96 overflow-y-auto">
                                {% for item in cart_items %}
                                <div class="cart-items flex items-center space-x-3 p-3 bg-gradient-to-r from-gray-50 to-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 border border-gray-100">
                                    <div class="relative">
                                        <img src="{{ item.menu_item.image.url }}" alt="{{ item.menu_item.name }}" 
                                             class="w-12 h-12 object-cover rounded-lg shadow-md">
                                        <div class="absolute -top-2 -right-2 w-6 h-6 bg-amber-400 text-white text-xs font-bold rounded-full flex items-center justify-center shadow-lg">
                                            {{ item.quantity }}
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h4 class="text-gray-800 truncate">{{ item.menu_item.name }}</h4>
                                        <p class="text-md bg-gradient-to-r from-amber-500 to-orange-500 bg-clip-text text-transparent" id="subtotal-{{ item.id }}">
                                            ‚Ç¶{{ item.subtotal }}
                                        </p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Price Summary -->
                            <div class="space-y-4 mb-8">
                                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                                    <span class="text-gray-600 font-medium">Subtotal</span>
                                    <span class="text-lg font-bold text-gray-800 total-amount">‚Ç¶{{ total }}</span>
                                </div>
                                
                                <div class="flex justify-between items-center py-3 bg-gradient-to-r from-amber-50 to-orange-50 -mx-4 px-4 rounded-xl">
                                    <span class="text-lg font-bold text-gray-800">Total</span>
                                    <span class="text-lg font-bold bg-gradient-to-r from-amber-500 to-orange-500 bg-clip-text text-transparent">
                                        ‚Ç¶{{ total }}
                                    </span>
                                </div>
                            </div>

                            <!-- Place Order Button -->
                            <button type="submit" id="placeOrderButton" 
                                    class="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white py-2 rounded-xl font-bold text-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg group mb-4">
                                <div class="flex items-center justify-center space-x-2">
                                    <span>Place Order</span>
                                </div>
                            </button>

                            <!-- Security Badges -->
                            <div class="space-y-2">
                                <div class="flex items-center justify-center space-x-2 text-green-700 text-sm p-3 bg-green-50 rounded-lg border border-green-200">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <span class="font-medium">Secure SSL Payment</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0 modal-content">
        <div class="p-8">
            <!-- Modal Header -->
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-r from-amber-400 to-orange-400 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-2.257-.257A6 6 0 1118 8zM10 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Login Required</h2>
                <p class="text-gray-600">Please login to continue with your order</p>
            </div>

            <!-- Login Form -->
            <form method="post" action="{% url 'login' %}" id="login-form" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="login_source" value="modal">
                <input type="hidden" name="next" value="/checkout/">
                
                <div class="group">
                    <label for="username" class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                    <div class="relative">
                        <input type="text" name="username" id="username" required
                               class="w-full px-4 py-3 pl-12 rounded-xl border-2 border-gray-200 focus:border-amber-400 focus:ring-4 focus:ring-amber-100 transition-all duration-300 bg-white shadow-sm group-hover:shadow-md">
                        <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>
                
                <div class="group">
                    <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" name="password" id="password" required
                               class="w-full px-4 py-3 pl-12 rounded-xl border-2 border-gray-200 focus:border-amber-400 focus:ring-4 focus:ring-amber-100 transition-all duration-300 bg-white shadow-sm group-hover:shadow-md">
                        <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" name="remember" id="remember" class="w-4 h-4 text-amber-600 border-gray-300 rounded focus:ring-amber-500">
                    <label for="remember" class="ml-2 text-sm text-gray-600">Remember me</label>
                </div>
                
                <div id="loginError" class="text-red-600 text-sm hidden"></div>
                
                <div class="flex flex-col space-y-3">
                    <button type="submit" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white py-3 rounded-xl font-bold transition-all duration-300 transform hover:scale-105 hover:shadow-lg">
                        Login to Continue
                    </button>
                    
                    <div class="text-center">
                        <a href="{% url 'signup' %}" class="text-amber-600 hover:text-amber-700 font-medium transition-colors">
                            Don't have an account? Create one
                        </a>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Close Button -->
        <button id="closeModal" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-all duration-200">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 flex flex-col items-center space-y-4 shadow-2xl">
        <div class="w-12 h-12 border-4 border-amber-200 border-t-amber-500 rounded-full animate-spin"></div>
        <p class="text-gray-700 font-medium">Processing your order...</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block customJS %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const deliveryOptions = document.getElementsByName('delivery_option');
        const deliveryAddressField = document.querySelector('.delivery_address');
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('login-form');
        const closeModal = document.getElementById('closeModal');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // Show loading overlay
        function showLoading() {
            if (loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
            }
        }

        // Hide loading overlay
        function hideLoading() {
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }

        // Show login modal with animation
        function showLoginModal() {
            loginModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Animate modal appearance
            setTimeout(() => {
                const modalContent = loginModal.querySelector('.modal-content');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // Hide login modal with animation
        function hideLoginModal() {
            const modalContent = loginModal.querySelector('.modal-content');
            modalContent.classList.add('scale-95', 'opacity-0');
            modalContent.classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                loginModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }, 300);
        }

        // Update delivery address visibility with animation
        function updateDeliveryAddressVisibility() {
            const selectedOption = document.querySelector('input[name="delivery_option"]:checked');
            if (selectedOption && selectedOption.value === 'delivery') {
                deliveryAddressField.classList.remove('hidden');
                deliveryAddressField.classList.add('animate-fade-in');
            } else {
                deliveryAddressField.classList.add('hidden');
                deliveryAddressField.classList.remove('animate-fade-in');
            }
        }
        
        // Set up event listeners for delivery options
        deliveryOptions.forEach(option => {
            option.addEventListener('change', updateDeliveryAddressVisibility);
        });
        
        // Initialize delivery address visibility
        updateDeliveryAddressVisibility();

        // Close modal events
        if (closeModal) {
            closeModal.addEventListener('click', hideLoginModal);
        }

        // Close modal when clicking outside
        if (loginModal) {
            loginModal.addEventListener('click', function(e) {
                if (e.target === loginModal) {
                    hideLoginModal();
                }
            });
        }

        // Handle login form submission
        if (loginForm) {
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const loginError = document.getElementById('loginError');
                
                try {
                    showLoading();
                    
                    const response = await fetch(this.action, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        hideLoginModal();
                        // Restore the checkout form data if it was saved
                        const savedFormData = sessionStorage.getItem('checkoutFormData');
                        if (savedFormData) {
                            const form = document.getElementById('checkoutForm');
                            if (form) {
                                const formData = new FormData();
                                const formDataObj = JSON.parse(savedFormData);
                                
                                // Set the form values
                                Object.entries(formDataObj).forEach(([key, value]) => {
                                    const input = form.querySelector(`[name="${key}"]`);
                                    if (input) {
                                        if (input.type === 'radio' || input.type === 'checkbox') {
                                            input.checked = input.value === value;
                                        } else if (input.tagName === 'TEXTAREA') {
                                            input.value = value;
                                            // Trigger any necessary events
                                            const event = new Event('input', { bubbles: true });
                                            input.dispatchEvent(event);
                                        } else {
                                            input.value = value;
                                        }
                                    }
                                });
                                
                                // Update delivery address visibility
                                updateDeliveryAddressVisibility();
                                
                                // Clear the saved form data
                                sessionStorage.removeItem('checkoutFormData');
                            }
                        }
                        
                        // Redirect to the original URL or checkout
                        window.location.href = data.redirect_url || '/checkout/';
                    } else {
                        loginError.textContent = data.message || 'Login failed. Please try again.';
                        loginError.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    loginError.textContent = 'An error occurred. Please try again.';
                    loginError.classList.remove('hidden');
                } finally {
                    hideLoading();
                }
            });
        }
        
        // Form submission
        const form = document.getElementById('checkoutForm');
        const placeOrderButton = document.getElementById('placeOrderButton');
        
        if (form && placeOrderButton) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const selectedOption = document.querySelector('input[name="delivery_option"]:checked');
                const deliveryAddress = document.querySelector('textarea[name="address"]');
                const deliveryAddressError = document.querySelector('.addressError');
                
                // Reset error states
                if (deliveryAddressError) deliveryAddressError.classList.add('hidden');
                if (deliveryAddress) {
                    deliveryAddress.classList.remove('border-red-600');
                    deliveryAddress.classList.add('border-gray-200');
                }
                
                // Validate delivery address if delivery is selected
                if (selectedOption && selectedOption.value === 'delivery') {
                    if (!deliveryAddress || !deliveryAddress.value.trim()) {
                        if (deliveryAddressError) deliveryAddressError.classList.remove('hidden');
                        if (deliveryAddress) {
                            deliveryAddress.classList.remove('border-gray-200');
                            deliveryAddress.classList.add('border-red-600');
                        }
                        deliveryAddress.focus();
                        return false;
                    }
                }

                // Show loading state
                const originalButtonText = placeOrderButton.innerHTML;
                placeOrderButton.disabled = true;
                placeOrderButton.innerHTML = `
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="animate-spin w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Processing...</span>
                    </div>
                `;

                try {
                    showLoading();
                    
                    const response = await fetch(this.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: formData
                    });

                    const data = await response.json();

                    if (response.status === 401 && data.status === 'auth_required') {
                        // Save form data to sessionStorage
                        const formData = new FormData(form);
                        const formDataObj = {};
                        formData.forEach((value, key) => {
                            formDataObj[key] = value;
                        });
                        sessionStorage.setItem('checkoutFormData', JSON.stringify(formDataObj));
                        
                        // Show login modal for delivery orders
                        hideLoading();
                        showLoginModal();
                        return;
                    }

                    if (response.ok && data.redirect_url) {
                        window.location.href = data.redirect_url;
                        return;
                    }

                    // If we get here, there was an error
                    alert(data.message || 'An error occurred. Please try again.');

                } catch (error) {
                    console.error('Checkout error:', error);
                    alert('An error occurred. Please try again.');
                } finally {
                    // Reset button state
                    hideLoading();
                    placeOrderButton.disabled = false;
                    placeOrderButton.innerHTML = originalButtonText;
                }
            });
        }

        // Add scroll animations for cart items
        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry, index) => {
                if (entry.isIntersecting) {
                    setTimeout(() => {
                        entry.target.classList.add('animate-fade-in-up');
                    }, index * 100);
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.cart-items').forEach(item => {
            observer.observe(item);
        });
    });

    // Add custom CSS animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Modal animation */
        .modal-content {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #f59e0b, #ea580c);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #d97706, #dc2626);
        }

        /* Radio button animations */
        input[type="radio"]:checked + div {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Form field focus animations */
        input:focus, textarea:focus {
            transform: translateY(-1px);
        }

        /* Button press effect */
        button:active {
            transform: scale(0.98);
        }

        /* Glassmorphism enhancement */
        .backdrop-blur-sm {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock customJS %}